<!DOCTYPE html>
<html>
  <head>
    <title>Zero downtime migrate mongodb to a larger disk space – Oslo – Backend Developer</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="好久沒寫筆記了，趁這假日的空擋，來寫寫這次遭遇的事件

" />
    <meta property="og:description" content="好久沒寫筆記了，趁這假日的空擋，來寫寫這次遭遇的事件

" />
    
    <meta name="author" content="Oslo" />

    
    <meta property="og:title" content="Zero downtime migrate mongodb to a larger disk space" />
    <meta property="twitter:title" content="Zero downtime migrate mongodb to a larger disk space" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Oslo - Backend Developer" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://avatars3.githubusercontent.com/u/5058547?v=3&s=460" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Oslo</a></h1>
            <p class="site-description">Backend Developer</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Zero downtime migrate mongodb to a larger disk space</h1>

  <div class="entry">
    <p>好久沒寫筆記了，趁這假日的空擋，來寫寫這次遭遇的事件</p>

<h1 id="section">起因</h1>

<p>這次事件，其實是因為公司的 MongoDB 的硬碟空間減少速度比預想中來得快(就商業來說是件好事！)
但對工程師來說就是個挑戰，因為出差回來，硬碟只剩下4％(估計剩下10天的容量)</p>

<p>一開始想法是砍資料，因為我們會將舊的資料放在 relation database上(又是另一個故事了)
原以為這樣能釋放 disk space (如果會就不會有這篇了。)
沒想到 MongoDB storage 的方式是，將資料一筆一筆堆疊在一起，最後合併成一個檔案直到這個檔案大小變成 <code class="highlighter-rouge">2G</code>，就會再開下一個檔案
可想而知，這樣，砍資料並不會將空間釋放。</p>

<p>舉例來說：</p>

<blockquote>
  <p>今天你是大盤商，要採收橘子、哈密瓜、西瓜，你將採收的水果分開箱子放，當你發現你收了好多箱之後，
車子可能快載不下了，想將每箱之間一些較小橘子拿出來丟掉，但你的卡車還是不會因為丟掉部分的橘子，而讓你放更多的箱子。</p>
</blockquote>

<blockquote>
  <p>橘子、哈密瓜跟西瓜 代表資料的大小，卡車代表你的硬碟空間，箱子則是上述的 <code class="highlighter-rouge">2G</code> 限制。</p>
</blockquote>

<p>解決辦法: 是類似以前的 <code class="highlighter-rouge">磁碟重組</code>，就是將橘子全部倒出來重新裝箱，但這工程可想而知，一定很複雜，而且會很耗時。</p>

<h4 id="section-1"><em>既然不能節流，那就開源吧</em></h4>

<p>其實有很多方法可以增加硬碟空間</p>

<ol>
  <li>趁半夜人少的時候爬起來停機，然後升級
    <ul>
      <li>缺點：需要停機、沒效率、降低工程師的快樂指數、沒挑戰性、很難自動化</li>
      <li>優點：快速、省錢、無腦升級、比較不會出錯</li>
    </ul>
  </li>
  <li>新開一群機器(cluster)，寫 sync 的程式
    <ul>
      <li>缺點：耗時、花錢且會有資料上 sync 的問題</li>
      <li>優點：zero-downtime、半自動化</li>
    </ul>
  </li>
</ol>

<p>我們其實也遭遇過一樣的問題幾次，之前都是採用 <code class="highlighter-rouge">1.</code> 的方法，確實在幾小時內就搞定了
但回想當工程師的初衷，不就是要很帥氣，按一個鍵就可以自動升級，還讓客戶無感嗎？</p>

<p>於是，這次就採用了 <code class="highlighter-rouge">2.</code> 的方法(也很感謝公司能給這個時間，讓我嘗試這種方法。)</p>

<h1 id="section-2">本文開始</h1>
<p>既然要很帥氣的挑戰 <code class="highlighter-rouge">zero-downtime</code> ，事前功課必不能少。
自從來了幾個很厲害的同事(*1)之後，學到了 工欲善其事，必先 google 的心法
(時間再怎麼趕，都要做好最好及最壞打算的規劃)</p>

<h3 id="section-3">現況</h3>
<ol>
  <li>我們 MongoDB 採用的是 <code class="highlighter-rouge">primary + 2 * slave</code> 的 <code class="highlighter-rouge">replica</code> 架構。</li>
  <li>每日台灣時間早上八點 (<code class="highlighter-rouge">UTC+0</code>) 會將資料用 <code class="highlighter-rouge">mongodump</code> 成 <code class="highlighter-rouge">bson</code> 檔案備份到 <code class="highlighter-rouge">AWS S3</code></li>
  <li>每小時用 <code class="highlighter-rouge">AWS CloudWatch Event bulit-in function</code> 做 <code class="highlighter-rouge">Snapshot</code></li>
  <li>資料容量約 2T</li>
</ol>

<h3 id="section-4">欲改善問題</h3>
<ol>
  <li>原本 VPC 架構有問題，想換成用 <code class="highlighter-rouge">CloudFormation</code> 程式化的 <code class="highlighter-rouge">infrastructure</code></li>
  <li>原本是利用 <code class="highlighter-rouge">CIDR /32</code> IP binding 的方法來讓公司可以直連<code class="highlighter-rouge">(for debug)</code>，但這樣有時候沒設定好，導致連測試資料也一起上去</li>
  <li>Production and Test data in the same place</li>
  <li>Cost and performance ratio too low (簡單來說，C/P值過低)</li>
  <li>Increase disk capacity</li>
</ol>

<h3 id="plan">Plan</h3>
<ol>
  <li>換程式化後的 <code class="highlighter-rouge">Infrastructure</code></li>
  <li>VPN</li>
  <li>增加一台測試的 MongoDB</li>
</ol>

<p>其實蠻有趣的，印象中當我們開始架設 MongoDB的時候，是用 AWS MarketPlace 中的 template 架設。</p>

<p>當時 template 給的 EBS 有幾個選項 <code class="highlighter-rouge">IOPS 1000, 2000, 4000</code>(type io2)，容量自訂，當時我們資料不多，所以選了 500GB 以及 <code class="highlighter-rouge">IOPS 1000</code> 的選項。
後來經過幾次容量升級的 events，都沒有對 <code class="highlighter-rouge">IOPS</code> 做特別的留意，但這樣其實是相當不划算的。</p>

<blockquote>
  <p>AWS 提供一個 <code class="highlighter-rouge">gp2</code> 的 SSD type，其 <code class="highlighter-rouge">IOPS</code> 為 <code class="highlighter-rouge">3 IOPS/GB</code>，在低於 1T 容量下，當有尖峰時刻的時候會 boost 到 <code class="highlighter-rouge">3000 IOPS</code>，超過 1T 後則固定數值，所以到 <code class="highlighter-rouge">3334GB</code> 後，<code class="highlighter-rouge">IOPS</code> 則固定為 <code class="highlighter-rouge">10000</code></p>
</blockquote>

<blockquote>
  <p><code class="highlighter-rouge">io2</code> 的好處是，當容量小的時候也可以固定 <code class="highlighter-rouge">IOPS</code>，但收費則硬碟容量以及 IOPS 兩個分開收(所以 貴！)</p>
</blockquote>

<p>所以我們要升級容量的時候順便將 SSD type 換成 gp2，<code class="highlighter-rouge">IOPS</code> 明顯提升，還更便宜。</p>

<h3 id="section-5">執行前實驗</h3>
<p>其實我當初已經有將 <code class="highlighter-rouge">Infrastructure</code> 寫成 <code class="highlighter-rouge">CloudFormation</code> ，所以這段時間已經省下來了(之後也會開源這塊)，重點在 migrate data 這塊</p>

<p>我們最初想到跟查到文件這裡都是建議使用 <code class="highlighter-rouge">mongodump + mongorestore</code> 來做 <code class="highlighter-rouge">migration</code>，但在我們公司會有個問題</p>

<blockquote>
  <p>我們公司的客戶有時候會離線操作，資料傳送並非即時，所以萬一上傳時間在備份的時間之後，還原的時候，就不會還原到新的 db 內。</p>
</blockquote>

<p>後來有想說利用 <code class="highlighter-rouge">mongooplog</code> 這塊，但這塊經實驗之後，發現會有很高的機會會把 <code class="highlighter-rouge">server shutdown</code>，所以並不採用</p>

<h4 id="sync-">最後還是靠寫程式，來將 sync 這段做好</h4>

<h3 id="section-6">執行</h3>
<ol>
  <li>CloudFormation one click open(需要注意 AWS soft limit: EIP, EBS capacity 等限制)</li>
  <li>migration(<code class="highlighter-rouge">mongodump</code>+<code class="highlighter-rouge">mongorestore</code>+<code class="highlighter-rouge">self sync script</code>)</li>
</ol>

<p>雖然研究以及 migrate 的過程中，我們一直在跟時間競賽(絕對不是 那美克星剩一分鐘爆炸，還有兩個禮拜可以演！)但這次的極限挑戰的經驗值卻是增加頗快的
加上之前一些基礎建設的 refactor 也間接加速這次的過程。</p>

<p>很感謝公司的各位同事，在這段時間的 cover ，雖然最後結果上還是發現有一些小小的問題，但以 <code class="highlighter-rouge">zero-downtime</code> 的挑戰來說，卻是成功的！</p>

<p>*1: 高手等級人物 <a href="https://github.com/johnlinvc">John</a>、<a href="https://github.com/sodastsai">Sodas</a></p>

  </div>

  <div class="date">
    Written on December 25, 2016
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/oslo0322"><i class="svg-icon github"></i></a>








        </footer>
      </div>
    </div>

    

  </body>
</html>
